# 1. æ¶æ„æ¦‚è§ˆ

æ¬¢è¿æ¥åˆ° `Calico` çš„æ ¸å¿ƒæ¦‚å¿µï¼åœ¨â€œå…¥é—¨æŒ‡å—â€å’Œâ€œæ“ä½œæŒ‡å—â€ä¸­ï¼Œæˆ‘ä»¬å­¦ä¹ äº†å¦‚ä½•*ä½¿ç”¨* API æ¥æ„å»ºå’Œæ‰§è¡Œ IRã€‚åœ¨è¿™ä¸€éƒ¨åˆ†ï¼Œæˆ‘ä»¬å°†æ·±å…¥æ¢è®¨è¿™äº› API èƒŒåâ€œæ˜¯ä»€ä¹ˆâ€å’Œâ€œä¸ºä»€ä¹ˆâ€çš„è®¾è®¡ã€‚

`Calico` çš„ IR æ¶æ„æ·±å— LLVM çš„å¯å‘ã€‚å®ƒä¸æ˜¯ä¸€ä¸ªå•ä¸€çš„å·¨å¤§ç»“æ„ï¼Œè€Œæ˜¯ä¸€ä¸ªç”±å¤šä¸ª**åˆ†å±‚å¯¹è±¡**ç»„æˆçš„ã€**å¼ºæ‰€æœ‰æƒ**çš„å›¾ã€‚

ç†è§£ `Calico` æ¶æ„æœ€å¿«çš„æ–¹æ³•æ˜¯å°†å…¶åˆ†è§£ä¸ºä¸¤ä¸ªä¸»è¦æ¦‚å¿µï¼š

1. **æ ¸å¿ƒå®¹å™¨ (Ownership)**ï¼š`IR` å¯¹è±¡çš„â€œçˆ¶å­â€å…³ç³»ï¼ˆâ€œè°æ‹¥æœ‰è°â€ï¼‰ã€‚
2. **å€¼ç³»ç»Ÿ (The Value System)**ï¼š`IRValue` å¦‚ä½•ä½œä¸ºâ€œç²˜åˆå‰‚â€è¿æ¥ä¸€åˆ‡ï¼ˆâ€œæ˜¯ä»€ä¹ˆâ€ï¼‰ã€‚

---

## ğŸ—ï¸ æ ¸å¿ƒå®¹å™¨ï¼šæ‰€æœ‰æƒå±‚æ¬¡

`Calico` IR å…·æœ‰ä¸¥æ ¼çš„æ ‘çŠ¶æ‰€æœ‰æƒç»“æ„ã€‚æ¯ä¸ªå¯¹è±¡ï¼ˆ`Function`ã€`BasicBlock` ç­‰ï¼‰éƒ½æ˜ç¡®çŸ¥é“å…¶â€œçˆ¶â€å¯¹è±¡æ˜¯è°ã€‚

è¿™ç§å±‚æ¬¡ç»“æ„å¦‚ä¸‹æ‰€ç¤ºï¼š

```
IRContext (æ•´ä¸ªâ€œå®‡å®™â€)
â””â”€ IRModule (ä¸€ä¸ªâ€œç¿»è¯‘å•å…ƒâ€)
â”œâ”€ IRGlobalVariable (å…¨å±€å˜é‡ @g\_data)
â””â”€ IRFunction (å‡½æ•° @my\_func)
â”œâ”€ IRArgument (å‚æ•° %arg)
â””â”€ IRBasicBlock (åŸºæœ¬å— $entry)
â””â”€ IRInstruction (æŒ‡ä»¤ %sum = add)
```

---

### 1. `IRContext` (æ¥è‡ª `ir/context.h`)

**`IRContext` æ˜¯ `Calico` çš„â€œå®‡å®™â€æˆ–â€œä¸­å¤®ç®¡ç†å™¨â€ã€‚**

* **å”¯ä¸€æ‰€æœ‰è€…**ï¼šå®ƒæ˜¯æ‰€æœ‰*æŒä¹…*å¯¹è±¡çš„æœ€ç»ˆæ‰€æœ‰è€…ã€‚å®ƒç®¡ç†ç€å†…å­˜ç«æŠ€åœºï¼ˆArenasï¼‰ï¼Œç”¨äºå¿«é€Ÿåˆ†é…æ‰€æœ‰å…¶ä»– IR å¯¹è±¡ï¼ˆ`Module`, `Function`, `Type` ç­‰ï¼‰ã€‚
* **å”¯ä¸€åŒ–ï¼ˆInterningï¼‰**ï¼šå®ƒæ˜¯æ‰€æœ‰ç±»å‹ï¼ˆ`Type`ï¼‰å’Œå¸¸é‡ï¼ˆ`Constant`ï¼‰çš„â€œå·¥å‚â€ã€‚å½“ä½ è¯·æ±‚ä¸€ä¸ª `i32` ç±»å‹æ—¶ï¼Œ`IRContext` ä¼šç¡®ä¿ä½ å¾—åˆ°çš„æ˜¯æŒ‡å‘**åŒä¸€ä¸ª** `i32` ç±»å‹å®ä¾‹çš„æŒ‡é’ˆã€‚è¿™ä½¿å¾—ç±»å‹å’Œå¸¸é‡çš„æ¯”è¾ƒå˜å¾—éå¸¸å¿«ï¼ˆåªéœ€æ¯”è¾ƒæŒ‡é’ˆï¼‰ã€‚
* **ç”Ÿå‘½å‘¨æœŸ**ï¼š`IRContext` æ˜¯ä½ åˆ›å»ºçš„ç¬¬ä¸€ä¸ªå¯¹è±¡ï¼Œä¹Ÿæ˜¯ä½ æœ€åé”€Fæ¯çš„å¯¹è±¡ã€‚é”€æ¯ `IRContext` ä¼šé‡Šæ”¾å®ƒæ‰€æ‹¥æœ‰çš„*æ‰€æœ‰* IRã€‚

### 2. `IRModule` (æ¥è‡ª `ir/module.h`)

**`IRModule` æ˜¯ IR ç»“æ„çš„â€œæ ¹èŠ‚ç‚¹â€ï¼Œä»£è¡¨ä¸€ä¸ªå®Œæ•´çš„ç¿»è¯‘å•å…ƒï¼ˆä¾‹å¦‚ï¼Œä¸€ä¸ª `.c` æ–‡ä»¶ï¼‰ã€‚**

* å®ƒæŒæœ‰ä¸€ä¸ªæŒ‡å‘å…¶çˆ¶ `IRContext` çš„æŒ‡é’ˆã€‚
* å®ƒæ‹¥æœ‰ä¸€ä¸ª `IRGlobalVariable` åˆ—è¡¨ï¼ˆä¾‹å¦‚ `@g_data`ï¼‰ã€‚
* å®ƒæ‹¥æœ‰ä¸€ä¸ª `IRFunction` åˆ—è¡¨ï¼ˆä¾‹å¦‚ `@main`ï¼‰ã€‚

### 3. `IRFunction` (æ¥è‡ª `ir/function.h`)

**`IRFunction` ä»£è¡¨ä¸€ä¸ªå¯è°ƒç”¨çš„ä»£ç å•å…ƒã€‚**

* å®ƒæŒæœ‰ä¸€ä¸ªæŒ‡å‘å…¶çˆ¶ `IRModule` çš„æŒ‡é’ˆã€‚
* å®ƒå®šä¹‰äº†å…¶**è¿”å›ç±»å‹**ï¼ˆä¾‹å¦‚ `i32`ï¼‰ã€‚
* å®ƒæ‹¥æœ‰ä¸€ä¸ª `IRArgument` åˆ—è¡¨ï¼ˆä¾‹å¦‚ `%a: i32`, `%b: i32`ï¼‰ã€‚
* å®ƒæ‹¥æœ‰ä¸€ä¸ª `IRBasicBlock` åˆ—è¡¨ï¼ˆä¾‹å¦‚ `$entry`, `$then`, `$end`ï¼‰ã€‚

### 4. `IRBasicBlock` (æ¥è‡ª `ir/basicblock.h`)

**`IRBasicBlock` ä»£è¡¨ä¸€ä¸ªâ€œåŸºæœ¬å—â€ï¼Œå³ä¸€ä¸ªæ²¡æœ‰å†…éƒ¨è·³è½¬çš„çº¿æ€§æŒ‡ä»¤åºåˆ—ã€‚**

* å®ƒæŒæœ‰ä¸€ä¸ªæŒ‡å‘å…¶çˆ¶ `IRFunction` çš„æŒ‡é’ˆã€‚
* å®ƒæ‹¥æœ‰ä¸€ä¸ª `IRInstruction` åˆ—è¡¨ã€‚
* `Calico` ä¸­çš„ `IRBasicBlock` å¿…é¡»ä»¥ä¸€ä¸ª**ç»ˆç»“è€…æŒ‡ä»¤**ï¼ˆ`ret`, `br`, `cond_br`, `switch`ï¼‰ç»“å°¾ã€‚

### 5. `IRInstruction` (æ¥è‡ª `ir/instruction.h`)

**`IRInstruction` æ˜¯æœ€å°çš„å¯æ‰§è¡Œä»£ç å•å…ƒã€‚**

* å®ƒæŒæœ‰ä¸€ä¸ªæŒ‡å‘å…¶çˆ¶ `IRBasicBlock` çš„æŒ‡é’ˆã€‚
* å®ƒæœ‰ä¸€ä¸ªæ“ä½œç ï¼ˆ`IROpcode`ï¼‰ï¼Œä¾‹å¦‚ `IR_OP_ADD`ã€‚
* å®ƒæ‹¥æœ‰ä¸€ä¸ª**æ“ä½œæ•°ï¼ˆOperandsï¼‰**åˆ—è¡¨ï¼Œè¿™äº›æ“ä½œæ•°æ˜¯é€šè¿‡ `IRUse` å¯¹è±¡è¿æ¥çš„ã€‚

---

## ğŸ§¬ `IRValue`ï¼šç»Ÿä¸€çš„å€¼ç³»ç»Ÿ

è™½ç„¶ä¸Šè¿°çš„â€œå®¹å™¨â€å±‚æ¬¡ç»“æ„ï¼ˆ`Module` -> `Function` -> `Block`ï¼‰å¾ˆå®¹æ˜“ç†è§£ï¼Œä½† `Calico`ï¼ˆå’Œ LLVMï¼‰çš„çœŸæ­£å¨åŠ›æ¥è‡ªäºå®ƒçš„**å€¼ï¼ˆValueï¼‰ç³»ç»Ÿ**ã€‚

**`IRValue`ï¼ˆåœ¨ `ir/value.h` ä¸­å®šä¹‰ï¼‰æ˜¯ `Calico` ä¸­æœ€é‡è¦çš„æ ¸å¿ƒæ¦‚å¿µã€‚**

> **æ ¸å¿ƒç†å¿µï¼š** â€œå¦‚æœä¸€ä¸ªä¸œè¥¿å¯ä»¥è¢«ç”¨ä½œæŒ‡ä»¤çš„æ“ä½œæ•°ï¼Œé‚£ä¹ˆå®ƒå°±æ˜¯ä¸€ä¸ª `IRValue`ã€‚â€

`IRValue` æœ¬èº«æ˜¯ä¸€ä¸ªâ€œåŸºç±»â€ï¼ˆé€šè¿‡Cè¯­è¨€çš„ç»“æ„ä½“ç»„åˆå®ç°ï¼‰ã€‚ä»¥ä¸‹æ‰€æœ‰å¯¹è±¡**éƒ½æ˜¯** `IRValue`ï¼š

* **`IRInstruction`** (çš„ *result*)
  * `_**%sum**: i32_ = add %a: i32, %b: i32`
  * `%sum` æ˜¯ä¸€ä¸ª `IRValue`ã€‚
* **`IRConstant`**
  * `%sum: i32 = add %a: i32, _**10**: i32_`
  * `10: i32` æ˜¯ä¸€ä¸ª `IRValue`ã€‚
* **`IRArgument`**
  * `%sum: i32 = add _**%a**: i32_, %b: i32`
  * `%a` æ˜¯ä¸€ä¸ª `IRValue`ã€‚
* **`IRGlobalVariable`**
  * `%ptr: <i32> = bitcast _**@g_data**: <[10xi32]>_ to <i32>`
  * `@g_data` æ˜¯ä¸€ä¸ª `IRValue` (å…¶ç±»å‹æ˜¯æŒ‡é’ˆ)ã€‚
* **`IRBasicBlock`** (çš„ *label*)
  * `br _**$end**_`
  * `$end` æ˜¯ä¸€ä¸ª `IRValue` (å…¶ç±»å‹æ˜¯ `label`)ã€‚

**è¿™æœ‰ä»€ä¹ˆå¥½å¤„ï¼Ÿ**
è¿™æ„å‘³ç€ä¸€ä¸ª `add` æŒ‡ä»¤**ä¸éœ€è¦å…³å¿ƒ**å®ƒæ˜¯åœ¨åŠ ä¸¤ä¸ª `IRArgument`ã€ä¸¤ä¸ª `IRConstant`ã€è¿˜æ˜¯ä¸¤ä¸ª `IRInstruction` çš„ç»“æœã€‚å®ƒåªçŸ¥é“å®ƒéœ€è¦ä¸¤ä¸ªæŒ‡å‘ `IRValue` çš„æŒ‡é’ˆï¼Œå¹¶ä¸”è¿™ä¸¤ä¸ª `IRValue` çš„ç±»å‹éƒ½æ˜¯ `i32`ã€‚

---

## ğŸ”— Use-Def é“¾ (æ¥è‡ª `ir/use.h`)

`IRValue` ç³»ç»Ÿæ˜¯é€šè¿‡ `Use-Def`ï¼ˆä½¿ç”¨-å®šä¹‰ï¼‰é“¾è¿æ¥èµ·æ¥çš„ã€‚

* **Def-Use (å®šä¹‰ -> ä½¿ç”¨)**ï¼š
  * ä¸€ä¸ª `IRInstruction`ï¼ˆä¾‹å¦‚ `add`ï¼‰æ‹¥æœ‰ä¸€ä¸ªå®ƒæ‰€â€œä½¿ç”¨â€çš„ `IRValue` åˆ—è¡¨ï¼ˆæ“ä½œæ•°åˆ—è¡¨ï¼‰ã€‚
  * ä¾‹å¦‚ï¼š`add` æŒ‡ä»¤**ä½¿ç”¨**äº† `%a` å’Œ `%b`ã€‚
* **Use-Def (ä½¿ç”¨ -> å®šä¹‰)**ï¼š
  * æ¯ä¸€ä¸ª `IRValue`ï¼ˆä¾‹å¦‚ `%a`ï¼‰éƒ½æ‹¥æœ‰ä¸€ä¸ªâ€œä½¿ç”¨â€å®ƒçš„æ‰€æœ‰æŒ‡ä»¤çš„**åˆ—è¡¨**ã€‚
  * ä¾‹å¦‚ï¼š`%a` è¿™ä¸ª `IRValue` **è¢«** `add` æŒ‡ä»¤æ‰€ä½¿ç”¨ã€‚

`ir/use.h` ä¸­çš„ `IRUse` ç»“æ„å°±æ˜¯å®ç°è¿™ä¸ªåŒå‘é“¾æ¥çš„â€œä¸­é—´äººâ€ã€‚è¿™ä½¿å¾—åƒ `ir_value_replace_all_uses_with()` è¿™æ ·çš„é«˜çº§é‡æ„ï¼ˆåœ¨ `mem2reg` ä¸­ä½¿ç”¨ï¼‰æˆä¸ºå¯èƒ½ã€‚

## 4.6. ä¸‹ä¸€æ­¥

ç°åœ¨ä½ å·²ç»ç†è§£äº† `Calico` IR çš„**æ•°æ®ç»“æ„**ï¼Œä¸‹ä¸€æ­¥æ˜¯å­¦ä¹ å®ƒçš„**æ–‡æœ¬è¯­æ³•**ã€‚

[-> ä¸‹ä¸€ç¯‡ï¼šæ ¸å¿ƒæ¦‚å¿µï¼š`calir` æ–‡æœ¬ IR æ ¼å¼](02_calir_text_format.md)
